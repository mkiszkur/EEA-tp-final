---
title: "EEA 2023 - Trabajo Final - Argento Fernando - Kiszkurno Miguel"
output:
  html_document:
    df_print: paged
---

# Setup

```{r limpieza memoria}
# limpio la memoria
rm(list = ls()) # remove all objects
gc() # garbage collection

knitr::opts_knit$set(root.dir = "/Users/miguelkiszkurno/Documents/EEA-tp-final")

```

```{r librerias, warning=FALSE, message=FALSE}

# Importo las librerías que voy a usar
#install.packages("robustbase")

library(tidyverse)
library(corrr)
library(knitr)
library(kableExtra)
library(GGally)
library(tidymodels)
library(rsample)
library(ggplot2)
library(robustbase)
library(ordinal)  #ordinal regression package

```

```{r working directory}
# Establezco el Working Directory
#setwd("/Users/miguelkiszkurno/Documents/EEA-tp-final") 

#Semilla que voy a usar durante la notebook
semilla = 730 
```

#Análisis estructura y correlación

```{r cargar y visualizar datos}
# cargo los datos en dataset

#Dataset de train
cat (getwd())

ds <- read.table(paste0("/Users/miguelkiszkurno/Documents/EEA-tp-final/datasets/ENFR-2018-Base usuario.txt"),
                        sep="|", dec=".", header = TRUE, fill = TRUE)

#Vista general del dataset
glimpse(ds)

```

```{r seleccionar columnas}
names(ds)[names(ds) == "bhch03"] <- "sexo"
names(ds)[names(ds) == "bhch04"] <- "edad"
names(ds)[names(ds) == "consumo_tabaco_100"] <- "condicion_fumador"

names(ds)[names(ds) == "bisg01"] <- "salud"

ds <- ds[, c("edad", "condicion_fumador", "sexo", "salud")]
ds

```
```{r valores unicos y faltantes}

#Miro los valores unicos y los datos faltantes
tabla_exploratorios =  ds %>%
                                      gather(., 
                                            key = "variables", 
                                            value = "valores") %>% # agrupamos por las variables del set
                                      group_by(variables) %>% 
                                      summarise(valores_unicos = n_distinct(valores),
                                      porcentaje_faltantes = sum(is.na(valores))/nrow(ds)*100) %>% 
                                      arrange(desc(porcentaje_faltantes), valores_unicos) # ordenamos por porcentaje de 

#Visualizo la tabla
tabla_exploratorios

```


```{r convertir columnas}

ds$salud<- 5 - ds$salud 
ds$salud<- factor(ds$salud,
                          levels = c(4,3,2,1,0),
                          labels = c("excelente", "muy buena", "buena", "regular", "mala"))  #label ordinal var

ds$sexo<- factor(ds$sexo,
                         levels = c(1,2),
                         labels = c("Varón", "Mujer"))  #label sex

ds$condicion_fumador<- factor(ds$condicion_fumador,
                         levels = c(1,2,3),
                         labels = c("Fumador actual", "Ex fumador", "No fumador"))  #label sex

ds
```


```{r rango etario}
#Confirmamos que no hay registros de gente menor de 18 años
ds_mayores <- ds[ds$edad >= 18,]

# Contar registros con bhch04 >= 18
n_mayor18 <- nrow(ds_mayores)

# Contar registros con bhch04 < 18 
n_menor18 <- nrow(ds) - n_mayor18

# Imprimir recuentos
print(paste("Registros con edad >= 18:", n_mayor18))
print(paste("Registros con edad < 18:", n_menor18))
```






Ahora vamos a mirar algunas métricas descriptivas de las distintas variable numéricas del dataset.

```{r Metricas descriptivas}

#Miramos el mínimo, la media, etc. de las variables.
metricas <- ds %>%
      select_if(is.numeric) %>% 
      gather(., 
             key = "variable", 
             value = "valores") %>% # agrupamos por las variables del set
             group_by(variable) %>%
                  summarise(minimo = min(valores),
                            media = mean(valores),
                            mediana = median(valores),
                            desvio = sd(valores),
                            maximo = max(valores) ) %>% 
                                      arrange(variable) # orden
metricas

```


```{r relacion entre variables numericas, message=FALSE, warning=FALSE, fig.width=8, fig.height=8}

#Miro la relación entre las variables 

ggpairs(ds,  mapping = aes(color = sexo))+
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

ggpairs(ds,  mapping = aes(color = condicion_fumador))+
  theme(axis.text.x = element_text(angle = 30, hjust = 1))+
  scale_color_manual(values = c('No Fumador' = 'blue', 'Fumador' = 'red'))

```

La interpretación de un gráfico de mosaico se basa en observar el tamaño de las celdas y la distribución:

El tamaño de cada celda es proporcional a la frecuencia de cada combinación de categorías. Es decir, celdas más grandes significan más casos.
La posición y agrupación de las celdas permite observar la distribución conjunta de las variables. Celdas grandes cercanas indican asociación entre esas categorías.
Se puede comparar visualmente si hay más o menos casos entre categorías, tanto entre niveles de una misma variable (filas/columnas) como entre la interacción de ambas variables.
Por ejemplo, en un mosaico con "Fumadores (Si/No)" y "Sexo (Hombre/Mujer)", podríamos interpretar cosas como:

Hay más hombres fumadores que mujeres (la celda es más grande).
Parece haber asociación entre ser Hombre y ser Fumador (celdas grandes cercanas).
Hay más mujeres no fumadoras que hombres no fumadores.
En resumen, el tamaño y la posición de las celdas del mosaico revelan la distribución, frecuencias y asociación entre dos o más variables categóricas. ¡Mientras más grande y más cerca, más asociación entre esas categorías!

Se complementa bien con test estadísticos, pero de forma visual resume relaciones interesantes en los datos.


Existe una relación importante entre el ancho y el alto de las celdas en el gráfico de mosaico:

El área de cada celda (ancho x alto) es proporcional al número de casos en esa combinación de categorías. Es decir, celdas de mayor área representan más casos.
El ancho de cada celda representa la proporción de casos en esa categoría respecto al total de su grupo o fila del mosaico.
De forma similar, el alto representa la proporción de casos por columna o grupo del mosaico.
Así que podríamos decir que:

El ancho compara proporciones dentro de cadacategoría de la variable de filas (ej. Hombres Fumadores vs todos los Hombres).
El alto compara proporciones dentro de la variable de columnas (ej. Hombres Fumadores vs todas las personas Fumadoras).
El área de la celda indica la cantidad de casos en términos absolutos.
En resumen, el ancho y alto revelan proporciones y comparaciones dentro de cada variable/grupo, mientras que el área de la celda como producto de ambos indica la frecuencia absoluta de casos. ¡Juntos permiten hacer análisis relativos y absolutos!





```{r mozaicos}
library(vcd)
cols <- c("red", "blue", "green", 'brown', 'yellow')
mosaicplot(table(ds$condicion_fumador, ds$salud), 
          main="Mosaico para Fumadores vs salud",
          xlab="Condición Fumador", 
          las=1, # Rotar eje y 30 grados
          ylab="Salud",
          color = cols)

mosaicplot(table(ds$sexo, ds$salud), 
          main="Mosaico para Fumadores vs salud",
          xlab="sexo", 
          las=1, # Rotar eje y 30 grados
          ylab="Salud",
          color = cols)

```

```{r}
ggplot(ds, aes(x = salud, y = edad, fill = salud)) +   
  geom_boxplot(size = .75) +   facet_grid(condicion_fumador ~ sexo, margins = FALSE) +   
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```


Se utiliza la función assocstats() del paquete vcd en R. Esta función calcula estadísticos de asociación para tablas mayores que 2x2, incluyendo el coeficiente de contingencia de Pearson (Cramer's V).

Este coeficiente varía también entre 0 y 1, donde 0 = no asociación y 1 = máxima asociación. Se interpreta de manera similar a phi.

Es una muy buena alternativa para variables categóricas con múltiples valores (>2)

 Un coeficiente de contingencia de Pearson de 0.044 indica que existe una asociación débil entre las dos variables categóricas analizadas en la tabla de contingencia.

Como regla general, se suele interpretar este coeficiente de la siguiente manera:

* 0 a 0.1 = Asociación débil o nula
* >0.1 a 0.3 = Asociación baja 
* >0.3 a 0.6 = Asociación moderada
* >0.6 a 0.8 = Asociación fuerte
* >0.8 a 1 = Asociación muy fuerte

Por lo tanto, un valor de 0.044 se considera una asociación prácticamente débil o nula entre las variables categóricas. Esto implica que sabiendo el valor de una variable no te permite predecir o estar muy seguro del valor que tendrá la otra variable.

Se podría decir que son relativamente independientes, su conocimiento conjunto no aporta mucho más que conocerlas por separado. No permite realizar inferencias o predicciones cruzadas con alta certeza.

En conclusión, el bajo coeficiente de contingencia de Pearson obtenido indica que las variables categóricas en la tabla tienen una asociación débil o casi nula entre sí.


```{r asociacion condicion fumador vs salud}

tabla <- table(ds$condicion_fumador, ds$salud)

# Función phi()
assoc <- assocstats(tabla)$cramer

# Resultado
print(assoc)
```

```{r asociacion sexo salud}

tabla <- table(ds$sexo, ds$salud)

# Función phi()
assoc <- assocstats(tabla)$cramer

# Resultado
print(assoc)
```

```{r}
ds
new_data <- ds[sample(nrow(ds), 1), ]
new_data <- new_data[ , 1:ncol(new_data), drop = FALSE]  # Mantener como un data.frame
rownames(new_data) <- NULL  # Restablecer el índice
new_data

```

# Modelo (con Ordinal)

## logit

Intercepto para las categorías de "salud":

Excelente|muy buena: -1.00904
Muy buena|buena: 0.66193
Buena|regular: 2.61548
Regular|mala: 4.99800
Estos valores representan los puntos de corte (thresholds) entre las categorías ordinales de "salud".

Coeficientes para las variables predictoras:

Edad: El coeficiente es 0.0294458. Esto significa que, manteniendo constantes las otras variables, por cada aumento de una unidad en la edad, se espera un aumento del log-odds de "salud" en 0.0294458. Dado que la edad es positiva, se espera que a medida que la edad aumenta, la categoría de "salud" también tenga más probabilidad de aumentar.

Sexo (Mujer): El coeficiente es 0.2553960. Esto significa que, en comparación con los hombres (tomados como referencia), las mujeres tienen una probabilidad más alta de pertenecer a una categoría superior de "salud".

Condición de fumador (Ex fumador y No fumador): Los coeficientes son -0.1715150 y -0.2879516, respectivamente. Estos valores indican que, en comparación con aquellos que no son ex fumadores o no fumadores (tomados como referencia), los ex fumadores y los no fumadores tienen menos probabilidad de pertenecer a una categoría superior de "salud".

Significancia estadística:

Cada coeficiente tiene su propio valor p ("Pr(>|z|)"). Los valores pequeños (por ejemplo, < 0.05) indican que el coeficiente es significativamente diferente de cero. En tu caso, todos los coeficientes son significativos, ya que todos los valores p son muy pequeños.


```{r modelo 1 - logit}

modelo_logit <- clm(salud~edad + sexo + condicion_fumador,
              data = ds,
              link = "logit",
              Hess = TRUE)


summary(modelo_logit)


```
Add all model terms to scale and nominal formulae and perform likelihood ratio tests. These tests
can be viewed as goodness-of-fit tests. With the logit link, nominal_test provides likelihood ratio
tests of the proportional odds assumption. The scale_test tests can be given a similar interpretation
```{r nominal test}
nominal_test(modelo_logit)

```


```{r nuevo dato a predecir}

# Crear un nuevo data frame con los datos para la predicción
dato <- data.frame(
  edad = 45,
  sexo = "Varón",
  condicion_fumador = "Ex fumador"
)
```

```{r predecir manualmente}

# Coeficientes del modelo
c_edad <- 0.0294458  
c_sexo_mujer <- 0.2553960
c_ex_fumador <- -0.1715150 
c_no_fumador <- -0.2879516

# Thresholds
t_eb <- -1.00904    
t_mb <- 0.66193
t_b <- 2.61548
t_r <- 4.99800

# Dummy coding de variables categóricas
sexo_mujer <- dato$sexo == 'Mujer'
cond_fumador_ex <- dato$condicion_fumador == 'Ex fumador'
cond_fumador_no <- dato$condicion_fumador == 'No fumador'

# Linear predictor
eta <- c_edad * dato$edad + c_sexo_mujer * sexo_mujer + 
       c_ex_fumador *cond_fumador_ex + c_no_fumador * cond_fumador_no

# Probabilidades 

p_mala <- 1 / (1 + exp(t_r - eta))
p_regular <- 1 / (1 + exp(t_b - eta)) - p_mala
p_buena <- 1 / (1 + exp(t_mb - eta)) - p_regular - p_mala  
p_muybuena <- 1 / (1 + exp(t_eb - eta)) - p_buena - p_regular - p_mala
p_excelente <- 1 - (p_mala + p_regular + p_buena + p_muybuena)


# Imprimir probabilidades
cat("P(mala) =", p_mala, "\n")
cat("P(regular) =", p_regular, "\n")
cat("P(buena) =", p_buena, "\n")
cat("P(muybuena) =", p_muybuena, "\n")
cat("P(excelente) =", p_excelente, "\n")

```


```{r predecir un valor usando predict}


# Realizar la predicción
prediccion <- predict(modelo_logit, dato, type = "p")

# Mostrar las probabilidades
print(prediccion)

# Realizar la predicción
prediccion <- predict(modelo_logit, dato, type = "class")
print(prediccion)

```
```{r matriz confusion logit}
pred1 <- predict(modelo_logit, ds[, c('sexo', 'condicion_fumador', 'edad') ], type = "class")
tabla_conf <- table(pred1$fit, ds$salud)
tabla_conf
```

```{r comprobaciones logit}
n_excelente <- sum(ds$salud == 'muy buena')
n_excelente
#excelentes
#423 + 2465+25

#muy buenos
#672+6727+63

```


```{r tamaño error logit}
sum(diag(tabla_conf)) / sum(tabla_conf)

```

El tamaño de error del modelo es de 41% de los casos.

##probit

```{r modelo 2 - probit}

modelo_probit <- clm(salud~edad + sexo + condicion_fumador,
              data = ds,
              link = "probit",
              Hess = TRUE)


summary(modelo_probit)


```

```{r nominal test}
nominal_test(modelo_probit)

```


```{r nuevo dato a predecir}

# Crear un nuevo data frame con los datos para la predicción
dato <- data.frame(
  edad = 45,
  sexo = "Varón",
  condicion_fumador = "Ex fumador"
)
```

```{r predecir manualmente}
# Coeficientes
b_edad <- 0.0169304 
b_sexoMujer <- 0.1509301
b_exfumador <- -0.0935019
b_nofumador <- -0.1610974

# Thresholds
t_r <- 2.77158
t_b <- 1.55066    
t_mb <- 0.36601
t_eb <- -0.58504

# Dummy coding de variables categóricas
sexo_mujer <- dato$sexo == 'Mujer'
cond_fumador_ex <- dato$condicion_fumador == 'Ex fumador'
cond_fumador_no <- dato$condicion_fumador == 'No fumador'


# Linear predictor
eta <- b_edad*dato$edad + b_sexoMujer*sexo_mujer +  
       b_exfumador*cond_fumador_ex + b_nofumador*cond_fumador_no
       
# Probabilidad de mala
# Prob de mala 
p_mala <- 1 - pnorm(t_r, eta, lower.tail = TRUE)   

# Prob de regular
p_regular <- pnorm(t_r, eta, lower.tail = TRUE) -  
            pnorm(t_b, eta, lower.tail = TRUE)
# Prob de buena
p_buena <- pnorm(t_b, eta, lower.tail = TRUE) - 
           pnorm(t_mb, eta, lower.tail = TRUE)

p_muybuena <- pnorm(t_mb, eta, lower.tail = TRUE) - 
              pnorm(t_eb, eta, lower.tail = TRUE)

# Excelente por complemento  
p_excelente <- 1 - (p_mala + p_regular + p_buena + p_muybuena)

# Imprimir  
cat("P(mala) =", p_mala, "\n") 
cat("P(regular) =", p_regular, "\n")  
cat("P(buena) =", p_buena, "\n")  
cat("P(muy buena) =", p_muybuena, "\n")
cat("P(excelente) =", p_excelente, "\n")
```


```{r predecir un valor usando predict}

# Realizar la predicción
prediccion <- predict(modelo_probit, dato, type = "p")

# Mostrar las probabilidades
print(prediccion)

# Realizar la predicción
prediccion <- predict(modelo_probit, dato, type = "class")
print(prediccion)

```
```{r matriz confusion logit}
pred1 <- predict(modelo_probit, ds[, c('sexo', 'condicion_fumador', 'edad') ], type = "class")
tabla_conf <- table(pred1$fit, ds$salud)
tabla_conf
```
